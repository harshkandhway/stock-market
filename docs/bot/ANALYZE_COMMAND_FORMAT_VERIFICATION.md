# /analyze Command Format Verification

## ‚úÖ Confirmed: /analyze Uses Comprehensive Formatter

The `/analyze <stock_name>` command uses **`format_analysis_comprehensive`** from `src/core/formatters.py`.

---

## Format Details

### Formatter Function
- **File**: `src/core/formatters.py`
- **Function**: `format_analysis_comprehensive()`
- **Output Mode**: `'bot'` (with emojis and MarkdownV2)

### Usage in /analyze Command
**File**: `src/bot/handlers/analyze.py` (lines 164-168)

```python
formatted_result = format_analysis_comprehensive(
    analysis,
    output_mode='bot',
    horizon=horizon
)
```

---

## Format Sections Included

The comprehensive formatter includes ALL these sections (same as `/analyze` output):

1. ‚úÖ **Header & Quick Verdict** - Box with recommendation and confidence
2. ‚úÖ **WHY THIS RECOMMENDATION?** - Decision breakdown:
   - Trend Analysis (3/3 bullish)
   - Momentum (3/3 bullish)
   - Volume (1/1 bullish)
   - Chart Patterns (3/3 bullish)
   - Risk Assessment
3. ‚úÖ **OVERALL SCORE** - Visual progress bar (üü¢üü¢üü¢üü¢üü¢‚ö´‚ö´‚ö´‚ö´‚ö´ 5/10)
4. ‚úÖ **YOUR ACTION PLAN** - Entry, target, stop loss, timeline
5. ‚úÖ **KEY PRICE LEVELS** - Current, resistance, support
6. ‚úÖ **MARKET CONDITIONS** - Phase, trend strength, momentum, volume
7. ‚úÖ **TECHNICAL INDICATORS DETAIL** - RSI, MACD, ADX, Volume, EMA
8. ‚úÖ **CHART PATTERNS** - Pattern bias, strongest pattern details
9. ‚úÖ **SAFETY & RISK SUMMARY** - Safety score, rating, risk factors
10. ‚úÖ **TIMELINE ESTIMATE** - Hold duration, expected dates

---

## Score Calculation Fix Applied ‚úÖ

**Before Fix**:
- Formatter recalculated score independently
- Could show 9/10 while analysis service calculated 5/10
- **Result**: Contradiction

**After Fix**:
- Formatter uses `overall_score_pct` from analysis service
- **Single source of truth** - no recalculation
- **Result**: Consistent scores (5/10 = 50%)

**File**: `src/core/formatters.py` (lines 534-548)

```python
# CRITICAL FIX: Use overall_score_pct from analysis service
if 'overall_score_pct' in analysis:
    score_pct = analysis['overall_score_pct']
    total_bullish = int(round((score_pct / 100) * 10))
else:
    # Fallback (should rarely be used)
    total_bullish = trend_score + momentum_score + volume_score + pattern_score + risk_score
    score_pct = (total_bullish / 10) * 100
```

---

## Other Places Using This Format

### ‚úÖ Uses Comprehensive Formatter:
1. **`/analyze` command** - `src/bot/handlers/analyze.py`
2. **`/quick_analyze` command** - `src/bot/handlers/analyze.py`
3. **Refresh button callback** - `src/bot/handlers/callbacks.py`
4. **Quick analyze callback** - `src/bot/handlers/callbacks.py`

### ‚ö†Ô∏è Uses Simplified Format (Intentional):
1. **Daily BUY Alerts** - `src/bot/services/notification_service.py`
   - Uses simplified format (shorter, for notifications)
   - Not the comprehensive format (by design)

---

## Test Verification

**Test Script**: `test_analyze_format.py`

**Result**:
```
Score: 50.0% ‚úÖ
Recommendation: AVOID - BUY BLOCKED ‚úÖ
Formatter Score: 5/10 ‚úÖ
```

**Format Output**: Matches exactly what `/analyze` command shows.

---

## Summary

‚úÖ **The `/analyze` command uses `format_analysis_comprehensive` from `src/core/formatters.py`**

‚úÖ **Score calculation is now aligned** - uses `overall_score_pct` from analysis service

‚úÖ **All sections are included** - comprehensive format with all details

‚úÖ **Format is consistent** - same format used across all analysis commands

---

**Status**: ‚úÖ Verified and Fixed

The format generated by `/analyze <stock_name>` is the comprehensive format from `src/core/formatters.py`, and the score calculation has been fixed to match the analysis service.

